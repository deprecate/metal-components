define(["exports","metal/src/metal","metal-events/src/events"],function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function n(e){i(this,n);var o=a(this,t.call(this));return o.scheduledBatchData_=null,o.stateInfo_={},o.config={},o.updateConfig_(e||{}),o.setShouldUseFacade(!0),o.mergeInvalidKeys_(),o.addToStateFromStaticHint_(e),o}return o(n,t),n.prototype.addKeyToState=function(t,e,n){this.buildKeyInfo_(t,e,n),Object.defineProperty(this,t,this.buildKeyPropertyDef_(t))},n.prototype.addToState=function(t,n,i){if(e.core.isString(t))return this.addKeyToState(t,n,i);for(var a=n||{},o=Object.keys(t),r={},s=0;s<o.length;s++){var c=o[s];this.buildKeyInfo_(c,t[c],a[c]),r[c]=this.buildKeyPropertyDef_(c)}i!==!1&&Object.defineProperties(i||this,r)},n.prototype.addToStateFromStaticHint_=function(t){var e=this.constructor,i=!1;n.mergeStateStatic(e)&&(i=e.prototype),this.addToState(e.STATE_MERGED,t,i)},n.prototype.assertValidStateKeyName_=function(t){if(this.constructor.INVALID_KEYS_MERGED[t])throw new Error("It's not allowed to create a state key with the name \""+t+'".')},n.prototype.buildKeyInfo_=function(t,e,i){this.assertValidStateKeyName_(t),this.stateInfo_[t]={config:e||{},initialValue:i,state:n.KeyStates.UNINITIALIZED}},n.prototype.buildKeyPropertyDef_=function(t){return{configurable:!0,enumerable:!0,get:function(){return this.getStateKeyValue_(t)},set:function(e){this.setStateKeyValue_(t,e)}}},n.prototype.callFunction_=function(t,n){return e.core.isString(t)?this[t].apply(this,n):e.core.isFunction(t)?t.apply(this,n):void 0},n.prototype.callSetter_=function(t,e,n){var i=this.stateInfo_[t],a=i.config;return a.setter&&(e=this.callFunction_(a.setter,[e,n])),e},n.prototype.callValidator_=function(t,e){var n=this.stateInfo_[t],i=n.config;return i.validator?this.callFunction_(i.validator,[e,t]):!0},n.prototype.canSetState=function(t){var e=this.stateInfo_[t];return!e.config.writeOnce||!e.written},n.prototype.disposeInternal=function(){t.prototype.disposeInternal.call(this),this.stateInfo_=null,this.scheduledBatchData_=null},n.prototype.emitBatchEvent_=function(){if(!this.isDisposed()){var t=this.scheduledBatchData_;this.scheduledBatchData_=null,this.emit("stateChanged",t)}},n.prototype.get=function(t){return this[t]},n.prototype.getState=function(t){for(var e={},n=t||this.getStateKeys(),i=0;i<n.length;i++)e[n[i]]=this[n[i]];return e},n.prototype.getStateKeyConfig=function(t){return(this.stateInfo_[t]||{}).config},n.prototype.getStateKeys=function(){return Object.keys(this.stateInfo_)},n.prototype.getStateKeyValue_=function(t){return this.initStateKey_(t),this.stateInfo_[t].value},n.prototype.hasBeenSet=function(t){var e=this.stateInfo_[t];return e.state===n.KeyStates.INITIALIZED||e.initialValue},n.prototype.informChange_=function(t,e){if(this.shouldInformChange_(t,e)){var n={key:t,newVal:this[t],prevVal:e};this.emit(t+"Changed",n),this.emit("stateKeyChanged",n),this.scheduleBatchEvent_(n)}},n.prototype.initStateKey_=function(t){var e=this.stateInfo_[t];e.state===n.KeyStates.UNINITIALIZED&&(e.state=n.KeyStates.INITIALIZING,this.setInitialValue_(t),e.written||(e.state=n.KeyStates.INITIALIZING_DEFAULT,this.setDefaultValue_(t)),e.state=n.KeyStates.INITIALIZED)},n.mergeState_=function(t){return e.object.mixin.apply(null,[{}].concat(t.reverse()))},n.mergeStateStatic=function(t){return e.core.mergeSuperClassesProperty(t,"STATE",n.mergeState_)},n.prototype.mergeInvalidKeys_=function(){e.core.mergeSuperClassesProperty(this.constructor,"INVALID_KEYS",function(t){return e.array.flatten(t).reduce(function(t,e){return e&&(t[e]=!0),t},{})})},n.prototype.removeStateKey=function(t){this.stateInfo_[t]=null,delete this[t]},n.prototype.scheduleBatchEvent_=function(t){this.scheduledBatchData_||(e.async.nextTick(this.emitBatchEvent_,this),this.scheduledBatchData_={changes:{}});var n=t.key,i=this.scheduledBatchData_.changes;i[n]?i[n].newVal=t.newVal:i[n]=t},n.prototype.set=function(t,e){this[t]=e},n.prototype.setDefaultValue_=function(t){var e=this.stateInfo_[t].config;void 0!==e.value?this[t]=e.value:this[t]=this.callFunction_(e.valueFn)},n.prototype.setInitialValue_=function(t){var e=this.stateInfo_[t];void 0!==e.initialValue&&(this[t]=e.initialValue,e.initialValue=void 0)},n.prototype.setState=function(t,e){this.updateConfig_(t);for(var n=Object.keys(t),i=0;i<n.length;i++)this[n[i]]=t[n[i]];e&&this.scheduledBatchData_&&this.once("stateChanged",e)},n.prototype.setStateKeyValue_=function(t,e){if(this.canSetState(t)&&this.validateKeyValue_(t,e)){var i=this.stateInfo_[t];void 0===i.initialValue&&i.state===n.KeyStates.UNINITIALIZED&&(i.state=n.KeyStates.INITIALIZED);var a=this[t];i.value=this.callSetter_(t,e,a),i.written=!0,this.informChange_(t,a)}},n.prototype.shouldInformChange_=function(t,i){var a=this.stateInfo_[t];return a.state===n.KeyStates.INITIALIZED&&(e.core.isObject(i)||i!==this[t])},n.prototype.updateConfig_=function(t){var n=this.config;this.config=e.object.mixin({},this.config,t),this.emit("configChanged",{newVal:this.config,prevVal:n})},n.prototype.validateKeyValue_=function(t,e){var i=this.stateInfo_[t];return i.state===n.KeyStates.INITIALIZING_DEFAULT||this.callValidator_(t,e)},n}(n.EventEmitter);r.INVALID_KEYS=["config","state","stateKey"],r.KeyStates={UNINITIALIZED:0,INITIALIZING:1,INITIALIZING_DEFAULT:2,INITIALIZED:3},t["default"]=r});