define(["exports","metal/src/metal","metal-events/src/events"],function(t,e,n){"use strict";function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function n(o){a(this,n);var r=i(this,t.call(this));return r.scheduledBatchData_=null,r.stateInfo_={},r.config=e.object.mixin({},o||{}),r.setShouldUseFacade(!0),r.mergeInvalidKeys_(),r.addToStateFromStaticHint_(o),r}return o(n,t),n.prototype.addKeyToState=function(t,e,n){this.buildKeyInfo_(t,e,n),Object.defineProperty(this,t,this.buildKeyPropertyDef_(t))},n.prototype.addToState=function(t,n,a){if(e.core.isString(t))return this.addKeyToState(t,n,a);for(var i=n||{},o=Object.keys(t),r={},s=0;s<o.length;s++){var c=o[s];this.buildKeyInfo_(c,t[c],i[c]),r[c]=this.buildKeyPropertyDef_(c)}a!==!1&&Object.defineProperties(a||this,r)},n.prototype.addToStateFromStaticHint_=function(t){var e=this.constructor,a=!1;n.mergeStateStatic(e)&&(a=e.prototype),this.addToState(e.STATE_MERGED,t,a)},n.prototype.assertValidStateKeyName_=function(t){if(this.constructor.INVALID_KEYS_MERGED[t])throw new Error("It's not allowed to create a state key with the name \""+t+'".')},n.prototype.buildKeyInfo_=function(t,e,a){this.assertValidStateKeyName_(t),this.stateInfo_[t]={config:e||{},initialValue:a,state:n.KeyStates.UNINITIALIZED}},n.prototype.buildKeyPropertyDef_=function(t){return{configurable:!0,enumerable:!0,get:function(){return this.getStateKeyValue_(t)},set:function(e){this.setStateKeyValue_(t,e)}}},n.prototype.callFunction_=function(t,n){return e.core.isString(t)?this[t].apply(this,n):e.core.isFunction(t)?t.apply(this,n):void 0},n.prototype.callSetter_=function(t,e,n){var a=this.stateInfo_[t],i=a.config;return i.setter&&(e=this.callFunction_(i.setter,[e,n])),e},n.prototype.callValidator_=function(t,e){var n=this.stateInfo_[t],a=n.config;return a.validator?this.callFunction_(a.validator,[e]):!0},n.prototype.canSetState=function(t){var e=this.stateInfo_[t];return!e.config.writeOnce||!e.written},n.prototype.disposeInternal=function(){t.prototype.disposeInternal.call(this),this.stateInfo_=null,this.scheduledBatchData_=null},n.prototype.emitBatchEvent_=function(){if(!this.isDisposed()){var t=this.scheduledBatchData_;this.scheduledBatchData_=null,this.emit("stateChanged",t)}},n.prototype.get=function(t){return this[t]},n.prototype.getState=function(t){for(var e={},n=t||this.getStateKeys(),a=0;a<n.length;a++)e[n[a]]=this[n[a]];return e},n.prototype.getStateKeyConfig=function(t){return(this.stateInfo_[t]||{}).config},n.prototype.getStateKeys=function(){return Object.keys(this.stateInfo_)},n.prototype.getStateKeyValue_=function(t){return this.initStateKey_(t),this.stateInfo_[t].value},n.prototype.hasBeenSet=function(t){var e=this.stateInfo_[t];return e.state===n.KeyStates.INITIALIZED||e.initialValue},n.prototype.informChange_=function(t,e){if(this.shouldInformChange_(t,e)){var n={key:t,newVal:this[t],prevVal:e};this.emit(t+"Changed",n),this.emit("stateKeyChanged",n),this.scheduleBatchEvent_(n)}},n.prototype.initStateKey_=function(t){var e=this.stateInfo_[t];e.state===n.KeyStates.UNINITIALIZED&&(e.state=n.KeyStates.INITIALIZING,this.setInitialValue_(t),e.written||(e.state=n.KeyStates.INITIALIZING_DEFAULT,this.setDefaultValue_(t)),e.state=n.KeyStates.INITIALIZED)},n.mergeState_=function(t){return e.object.mixin.apply(null,[{}].concat(t.reverse()))},n.mergeStateStatic=function(t){return e.core.mergeSuperClassesProperty(t,"STATE",n.mergeState_)},n.prototype.mergeInvalidKeys_=function(){e.core.mergeSuperClassesProperty(this.constructor,"INVALID_KEYS",function(t){return e.array.flatten(t).reduce(function(t,e){return e&&(t[e]=!0),t},{})})},n.prototype.removeStateKey=function(t){this.stateInfo_[t]=null,delete this[t]},n.prototype.scheduleBatchEvent_=function(t){this.scheduledBatchData_||(e.async.nextTick(this.emitBatchEvent_,this),this.scheduledBatchData_={changes:{}});var n=t.key,a=this.scheduledBatchData_.changes;a[n]?a[n].newVal=t.newVal:a[n]=t},n.prototype.set=function(t,e){this[t]=e},n.prototype.setDefaultValue_=function(t){var e=this.stateInfo_[t].config;void 0!==e.value?this[t]=e.value:this[t]=this.callFunction_(e.valueFn)},n.prototype.setInitialValue_=function(t){var e=this.stateInfo_[t];void 0!==e.initialValue&&(this[t]=e.initialValue,e.initialValue=void 0)},n.prototype.setState=function(t){e.object.mixin(this.config,t);for(var n=Object.keys(t),a=0;a<n.length;a++)this[n[a]]=t[n[a]]},n.prototype.setStateKeyValue_=function(t,e){if(this.canSetState(t)&&this.validateKeyValue_(t,e)){var a=this.stateInfo_[t];void 0===a.initialValue&&a.state===n.KeyStates.UNINITIALIZED&&(a.state=n.KeyStates.INITIALIZED);var i=this[t];a.value=this.callSetter_(t,e,i),a.written=!0,this.informChange_(t,i)}},n.prototype.shouldInformChange_=function(t,a){var i=this.stateInfo_[t];return i.state===n.KeyStates.INITIALIZED&&(e.core.isObject(a)||a!==this[t])},n.prototype.validateKeyValue_=function(t,e){var a=this.stateInfo_[t];return a.state===n.KeyStates.INITIALIZING_DEFAULT||this.callValidator_(t,e)},n}(n.EventEmitter);r.INVALID_KEYS=["config","state","stateKey"],r.KeyStates={UNINITIALIZED:0,INITIALIZING:1,INITIALIZING_DEFAULT:2,INITIALIZED:3},t["default"]=r});