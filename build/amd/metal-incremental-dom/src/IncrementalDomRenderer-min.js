define(["exports","metal/src/metal","metal-dom/src/all/dom","metal-component/src/all/component","./IncrementalDomAop","./incremental-dom"],function(e,t,n,o,r){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function p(){}Object.defineProperty(e,"__esModule",{value:!0});var d=i(n),c=i(r),h=function(e){function n(t){a(this,n);var r=s(this,e.call(this,t));return t.context={},r.changes_={},r.eventsCollector_=new o.EventsCollector(t),r.lastElementCreationCall_=[],t.on("stateKeyChanged",r.handleStateKeyChanged_.bind(r)),t.on("attached",r.handleAttached_.bind(r)),t.on("detached",r.handleDetached_.bind(r)),r.handleInterceptedAttributesCall_=r.handleInterceptedAttributesCall_.bind(r),r.handleInterceptedOpenCall_=r.handleInterceptedOpenCall_.bind(r),r.handleInterceptedChildrenCloseCall_=r.handleInterceptedChildrenCloseCall_.bind(r),r.handleInterceptedChildrenOpenCall_=r.handleInterceptedChildrenOpenCall_.bind(r),r.handleInterceptedChildrenTextCall_=r.handleInterceptedChildrenTextCall_.bind(r),r.renderInsidePatchDontSkip_=r.renderInsidePatchDontSkip_.bind(r),r}return l(n,e),n.prototype.addInlineListeners_=function(e){for(var n=0;n<e.length;n+=2){var o=e[n],r=e[n+1];o.startsWith("data-on")&&t.core.isString(r)&&this.listenersToAttach_.push({eventName:o.substr(7),fn:r})}},n.prototype.attachInlineListeners_=function(){this.eventsCollector_.startCollecting();for(var e=0;e<this.listenersToAttach_.length;e++){var t=this.listenersToAttach_[e];this.eventsCollector_.attachListener(t.eventName,t.fn)}},n.prototype.buildChildrenFn_=function(e){var n=this;if(0===e.length)return p;var o=this.buildKey_(),r=function(){var r=n.currentPrefix_;n.generatedKeyCount_[o]=0,n.currentPrefix_=o,n.intercept_();for(var i=0;i<e.length;i++)IncrementalDOM[e[i].name].apply(null,t.array.slice(e[i].args,1));c["default"].stopInterception(),n.currentPrefix_=r};return r.iDomCalls=e,r},n.prototype.buildKey_=function(){var e=this.generatedKeyCount_[this.currentPrefix_]||0;return this.generatedKeyCount_[this.currentPrefix_]=e+1,this.currentPrefix_+"sub"+e},n.prototype.disposeUnusedSubComponents_=function(){for(var e=Object.keys(this.component_.components),t=[],n=0;n<e.length;n++)this.subComponentsFound_[e[n]]||t.push(e[n]);this.component_.disposeSubComponents(t)},n.getComponentBeingRendered=function(){return u[u.length-1]},n.prototype.getSubComponent_=function(e,t,n){var o=this.component_.addSubComponent(e,t,n);return o.wasRendered&&o.setState(n),o},n.prototype.guaranteeParent_=function(){var e=this.component_.element;if(!e||!e.parentNode){var t=document.createElement("div");return e&&d["default"].append(t,e),t}},n.finishedRenderingComponent=function(){u.pop()},n.prototype.handleAttached_=function(e){this.attachData_=e},n.prototype.handleDetached_=function(){this.eventsCollector_.detachAllListeners()},n.prototype.handleInterceptedAttributesCall_=function(e,n,o,r){if(o.startsWith("data-on")){var i=o.substr(7);t.core.isFunction(n[o])&&n.removeEventListener(i,n[o]),t.core.isFunction(r)&&d["default"].on(n,i,r)}else"checked"===o&&(n.checked=t.core.isDefAndNotNull(r)&&r!==!1);e(n,o,r)},n.prototype.handleInterceptedChildrenCloseCall_=function(e,t){if(this.isCurrentComponentTag_(t)&&0===--this.componentToRender_.tagsCount){var n=this.componentToRender_,o=n.calls,r=n.config,i=n.tag;r.children=this.buildChildrenFn_(o),this.componentToRender_=null,c["default"].stopInterception();var a=this.renderSubComponent_(i,r);return this.updateElementIfNotReached_(a),a.element}this.componentToRender_.calls.push({name:"elementClose",args:arguments})},n.prototype.handleInterceptedChildrenOpenCall_=function(e,t){this.isCurrentComponentTag_(t)&&this.componentToRender_.tagsCount++,this.componentToRender_.calls.push({name:"elementOpen",args:arguments})},n.prototype.handleInterceptedChildrenTextCall_=function(){this.componentToRender_.calls.push({name:"text",args:arguments})},n.prototype.handleInterceptedOpenCall_=function(e,t){return this.isComponentTag_(t)?this.handleSubComponentCall_.apply(this,arguments):this.handleRegularCall_.apply(this,arguments)},n.prototype.handleRegularCall_=function(e,o,r,i){var a=t.array.slice(arguments,4);this.addInlineListeners_((i||[]).concat(a));var s=t.array.slice(arguments,1),l=n.getComponentBeingRendered(),p=l.getRenderer();!p.rootElementReached_&&l.config.key&&(s[1]=l.config.key);var d=e.apply(null,s);return this.updateElementIfNotReached_(d,s),d},n.prototype.handleStateKeyChanged_=function(e){this.changes_[e.key]=e},n.prototype.handleSubComponentCall_=function(e,n,o,r){for(var i={key:o},a=(r||[]).concat(t.array.slice(arguments,4)),s=0;s<a.length;s+=2)i[a[s]]=a[s+1];this.componentToRender_={calls:[],config:i,tag:n,tagsCount:1},c["default"].startInterception({elementClose:this.handleInterceptedChildrenCloseCall_,elementOpen:this.handleInterceptedChildrenOpenCall_,text:this.handleInterceptedChildrenTextCall_})},n.prototype.hasChangedBesidesElement_=function(){var e=Object.keys(this.changes_).length;return this.changes_.hasOwnProperty("element")&&e--,e>0},n.prototype.intercept_=function(){c["default"].startInterception({attributes:this.handleInterceptedAttributesCall_,elementOpen:this.handleInterceptedOpenCall_})},n.prototype.isComponentTag_=function(e){return!t.core.isString(e)||e[0]===e[0].toUpperCase()},n.prototype.isCurrentComponentTag_=function(e){return this.isComponentTag_(e)&&this.componentToRender_.tag===e},n.prototype.render=function(){this.patch()},n.prototype.renderIncDom=function(){this.component_.render?this.component_.render():IncrementalDOM.elementVoid("div")},n.prototype.renderInsidePatch=function(){return this.component_.wasRendered&&!this.shouldUpdate(this.changes_)?void this.skipRerender_():void this.renderInsidePatchDontSkip_()},n.prototype.renderInsidePatchDontSkip_=function(){n.startedRenderingComponent(this.component_),this.changes_={},this.rootElementReached_=!1,this.subComponentsFound_={},this.generatedKeyCount_={},this.listenersToAttach_=[],this.currentPrefix_="",this.intercept_(),this.renderIncDom(),c["default"].stopInterception(),this.attachInlineListeners_(),n.finishedRenderingComponent(),this.rootElementReached_||(this.component_.element=null),this.emit("rendered",!this.component_.wasRendered)},n.prototype.renderSubComponent_=function(e,t){var o=t.key||this.buildKey_(),r=this.getSubComponent_(o,e,t);this.updateContext_(r);var i=r.getRenderer();return i instanceof n&&(i.lastParentComponent_=n.getComponentBeingRendered(),i.renderInsidePatch()),r.wasRendered||r.renderAsSubComponent(),this.subComponentsFound_[o]=!0,r},n.prototype.shouldUpdate=function(e){return this.component_.shouldUpdate?this.component_.shouldUpdate(e):!0},n.prototype.skipRerender_=function(){this.lastElementCreationCall_.length>0&&(IncrementalDOM.elementOpen.apply(null,this.lastElementCreationCall_),IncrementalDOM.skip(),IncrementalDOM.elementClose(this.lastElementCreationCall_[0]))},n.startedRenderingComponent=function(e){u.push(e)},n.prototype.patch=function(){if(!this.component_.element&&this.lastParentComponent_)return void this.lastParentComponent_.getRenderer().patch();var e=this.guaranteeParent_();if(e)IncrementalDOM.patch(e,this.renderInsidePatchDontSkip_),d["default"].exitDocument(this.component_.element),this.component_.element&&this.component_.inDocument&&this.component_.renderElement_(this.attachData_.parent,this.attachData_.sibling);else{var t=this.component_.element;IncrementalDOM.patchOuter(t,this.renderInsidePatchDontSkip_),this.component_.element||d["default"].exitDocument(t)}},n.prototype.update=function(){this.hasChangedBesidesElement_()&&this.shouldUpdate(this.changes_)&&(this.patch(),this.eventsCollector_.detachUnusedListeners(),this.disposeUnusedSubComponents_())},n.prototype.updateElementIfNotReached_=function(e,t){var r=n.getComponentBeingRendered(),i=r.getRenderer();if(!i.rootElementReached_){i.rootElementReached_=!0;var a=e,s=t;if(e instanceof o.Component){var l=e.getRenderer();s=l instanceof n?l.lastElementCreationCall_:[],a=e.element}r.element!==a&&(r.element=a),i.lastElementCreationCall_=s}},n.prototype.updateContext_=function(e){var o=e.context,r=n.getComponentBeingRendered(),i=r.getChildContext?r.getChildContext():{};t.object.mixin(o,r.context,i),e.context=o},n}(o.ComponentRenderer),u=[];p.calls=[],e["default"]=h});